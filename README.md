# Building a Fully Automated AWS CI/CD Pipeline for Node.js — From Scratch to Success

> **A real-world DevOps journey**: Overcoming `ScriptFailed`, `EACCES`, and permission hell to deploy a Node.js app using **AWS CodePipeline, CodeBuild, CodeDeploy, S3, EC2, and GitHub**.

---

![AWS CI/CD Pipeline](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8x1i1w3q3k4z5v7t9p0r.png)
*My final pipeline in action — Source → Build → Deploy*

---

## Introduction

In this project, I built a **production-grade CI/CD pipeline** for a **Node.js application** using **only AWS native services**:

- **GitHub** → Source
- **AWS CodeBuild** → Build
- **Amazon S3** → Artifact Storage
- **AWS CodeDeploy** → Deploy
- **AWS CodePipeline** → Orchestration
- **Amazon EC2** → Target Server

The app is a simple Express server that returns `"Hello from AWS CI/CD!"` on `port 3000`.

But this wasn’t a smooth ride. I faced **repeated `ScriptFailed` errors**, **`EACCES` permission issues**, and **artifacts with unwanted files**. This blog is the **complete story** — including **IAM roles**, **configuration files**, **debugging**, and **final success**.

---

## Project Structure


---

## Step 1: Create the S3 Bucket for Artifacts

```bash
aws s3 mb s3://myapp-cicd-artifacts-123 --region us-east-1
```
This bucket stores build-artifact.zip generated by CodeBuild.

## Step 2: Launch EC2 Instance & Install CodeDeploy Agent

1. **Launch EC2** (Ubuntu 22.04, t3.micro, `us-east-1`)
2. **Security Group**: Allow inbound:
   - SSH (22)
   - HTTP (3000)
3. **Install CodeDeploy Agent**:

```bash
sudo apt update && sudo apt install ruby wget -y
wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install
chmod +x install
sudo ./install auto
sudo systemctl status codedeploy-agent
```
**Tip**: Verify agent is running: sudo systemctl status codedeploy-agent

---

## Step 3: Create IAM Roles

IAM roles are **critical** for secure communication between AWS services. Below are the **four roles** created with **trust policies** and **permissions**.

---

### 1. EC2 Instance Role (`EC2CodeDeployRole`)

**Purpose**: Allows EC2 to download artifacts from S3 and communicate with CodeDeploy.

#### Trust Policy
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "ec2.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}
```
**Attached Policies**
- AmazonS3ReadOnlyAccess → To download build-artifact.zip
- AWSCodeDeployRole → For CodeDeploy operations
  
Attach this role to your EC2 instance via AWS Console → EC2 → Actions → Security → Modify IAM role.

---
### 2. CodeBuild Service Role (CodeBuildServiceRole)
**Purpose**: Allows CodeBuild to read source, write artifacts to S3, and log.
#### Trust Policy
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "codebuild.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}
```
**Attached Policies**

- AWSCodeBuildAdminAccess
- AmazonS3FullAccess → Required to upload build-artifact.zip to s3://myapp-cicd-artifacts-123
---
### 3. CodeDeploy Service Role (CodeDeployServiceRole)
**Purpose**: Allows CodeDeploy to manage deployments on EC2.
#### Trust Policy
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "codedeploy.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}
```
***Attached Policy***

AWSCodeDeployRole → Predefined AWS managed policy

---
### 4. CodePipeline Service Role (CodePipelineServiceRole)
**Purpose**: Orchestrates Source, Build, and Deploy stages.
#### Trust Policy
```json

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "codepipeline.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}
```
**Attached Policies**

- AWSCodePipelineFullAccess
- AWSCodeBuildAdminAccess
- AWSCodeDeployFullAccess
- AmazonS3FullAccess

---
### Step 4: GitHub Repository Setup
```bash
git init
git remote add origin https://github.com/ritesh/my-aws-cicd-app.git
```
.gitignore:
```text
node_modules/
package-lock.json
```
Why? Prevents EACCES errors by excluding locked files from artifacts.

---

### Step 5: buildspec.yml — Build Configuration
```yml
version: 0.2
phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - npm install
  build:
    commands:
      - echo "Build completed"
      - rm -rf node_modules package-lock.json
artifacts:
  files:
    - appspec.yml
    - index.js
    - package.json
    - scripts/**/*
  discard-paths: no
```

**Critical Fix**: rm -rf node_modules package-lock.json avoids permission conflicts.

---
### Step 6: appspec.yml — Deployment Steps
```yml
version: 0.1
os: linux
files:
  - source: /
    destination: /home/ubuntu/my-app
hooks:
  AfterInstall:
    - location: scripts/install_deps.sh
      timeout: 300
      runas: ubuntu
```

Runs install_deps.sh as ubuntu user to avoid root permission issues.

---
### Step 7: scripts/install_deps.sh — Fix Permissions
```bash
#!/bin/bash
cd /home/ubuntu/my-app
rm -rf node_modules package-lock.json
npm install --cache /home/ubuntu/.npm --no-audit
chmod -R u+w node_modules package-lock.json 2>/dev/null || true
```
---
**Key Fixes:**

- Clears old node_modules
- Uses custom npm cache
- Fixes write permissions

---
### Step 8: AWS CodeBuild Project (MyAppBuild)


| Field          | Value                                    |
|----------------|------------------------------------------|
| **Source**     | GitHub (`ritesh/my-aws-cicd-app`)        |
| **Environment**| Ubuntu, Node.js 18                       |
| **Buildspec**  | `buildspec.yml`                          |
| **Artifact**   | S3 → `myapp-cicd-artifacts-123`          |
| **Service Role**| `CodeBuildServiceRole`                  |

---
### Step 9: AWS CodeDeploy Application (MyAppDeploy)
- **Application Name**: MyAppDeploy
- **Compute Platform**: EC2/On-Premises
- **Deployment Group**: ProductionGroup
   - Tag: Name=MyAppServer
   - Instance: ip-172-31-19-118
- **Service Role**: CodeDeployServiceRole

---

### step 10 AWS CodePipeline (`MyAppPipeline`)

| Stage   | Provider       | Configuration                          |
|---------|----------------|----------------------------------------|
| **Source**  | GitHub (v2)    | `MyAppGitHubConnection`, `main` branch |
| **Build**   | CodeBuild      | `MyAppBuild`                           |
| **Deploy**  | CodeDeploy     | `MyAppDeploy`, `ProductionGroup`       |

---
